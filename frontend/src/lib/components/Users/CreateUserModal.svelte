<script lang="ts">
  import { Modal } from '$lib/components/modals';
  import t from '$lib/i18n';
  import { helpLinks } from '$lib/components/help';
  import { type LexAuthUser, type RegisterResponse } from '$lib/user';
  import CreateUser from '$lib/components/Users/CreateUser.svelte';
  import Markdown from 'svelte-exmarkdown';
  import { NewTabLinkRenderer } from '$lib/components/Markdown';
  import type {Component} from 'svelte';
  import Icon from '$lib/icons/Icon.svelte';
  import { createEventDispatcher } from 'svelte';

  const dispatch = createEventDispatcher<{
    submitted: LexAuthUser,
  }>();

  let createUserModal: Modal;
  export let handleSubmit: (password: string, passwordStrength: number, name: string, email: string, locale: string, turnstileToken: string) => Promise<RegisterResponse>;

  let formTainted = false;

  export async function open(): Promise<void> {
    await createUserModal.openModal(true, true);
  }
</script>

<Modal bind:this={createUserModal} bottom closeOnClickOutside={!formTainted}>
  <div class="alert alert-info gap-4 mb-4">
    <Icon icon="i-mdi-info-outline" size="text-2xl" />
    <div>
      <h3 class="text-lg">{$t('common.did_you_know')}</h3>
      <div>
        <Markdown
          md={$t('admin_dashboard.create_user_modal.help_create_single_guest_user', { helpLink: helpLinks.addProjectMember })}
          plugins={[{ renderer: { a: NewTabLinkRenderer as Component<any> } }]}
        />
        <Markdown
          md={$t('admin_dashboard.create_user_modal.help_create_bulk_guest_users', { helpLink: helpLinks.bulkAddCreate })}
          plugins={[{ renderer: { a: NewTabLinkRenderer as Component<any> } }]}
        />
      </div>
    </div>
  </div>
  <h1 class="text-center text-xl">{$t('admin_dashboard.create_user_modal.create_user')}</h1>
  <CreateUser {handleSubmit} allowUsernames skipTurnstile bind:formTainted
    on:submitted={(event) => {
      createUserModal.submitModal();
      dispatch('submitted', event.detail);
    }}
    submitButtonText={$t('admin_dashboard.create_user_modal.create_user')}
  />
</Modal>
