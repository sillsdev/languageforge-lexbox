<script lang="ts">
  import { getStores, navigating } from '$app/stores';
  import '$lib/app.postcss';
  import { initErrorStore } from '$lib/error';
  import UnexpectedErrorAlert from '$lib/error/UnexpectedErrorAlert.svelte';
  import type { LayoutData } from './$types';
  import Notify from '$lib/notify/Notify.svelte';
  import { Footer } from '$lib/layout';
  import { initNotificationService } from '$lib/notify';
  import { overlayContainer } from '$lib/overlay';
  import { Duration } from '$lib/util/time';
  import { browser } from '$app/environment';
  import t from '$lib/i18n';
  import {onMount, setContext} from 'svelte';
  import {derived, writable} from 'svelte/store';

  export let data: LayoutData;
  const { page, updated } = getStores();

  const { notifyWarning } = initNotificationService();
  setContext('breadcrumb-store', writable([] as Element[]));

  const error = initErrorStore($page.error);
  $: $error = $page.error;
  $: {
    if (browser && $updated) {
      notifyWarning($t('notifications.update_detected'), Duration.Long);
    }
  }

  let hydrating = true;
  onMount(() => hydrating = false);

  const loading = derived(navigating, (nav) => {
    if (!nav?.to) return false;
    if (!nav.from) return true;
    return nav.to.url.pathname !== nav.from.url.pathname;
  });
</script>

<div use:overlayContainer class="bg-base-200 shadow rounded-box z-[2] absolute" />

<svelte:head>
  {#if data.traceParent}
    <!--
      https://www.w3.org/TR/trace-context/#traceparent-header
      so the page-load instrumentation can be correlated with the server load
    -->
    <meta name="traceparent" content={data.traceParent} />
  {/if}
</svelte:head>

{#if $loading || hydrating}
  <progress class="progress progress-info block fixed z-50 h-[3px] rounded-none bg-transparent"></progress>
{/if}

<div class="flex flex-col justify-between min-h-full" class:hydrating>
  <div class="flex flex-col flex-grow">
    <slot />
  </div>
  <Footer />
</div>

<!-- We don't want the alert as well if we're heading to +error.svelte -->
{#if !$page.error}
  <UnexpectedErrorAlert />
{/if}

<Notify />
