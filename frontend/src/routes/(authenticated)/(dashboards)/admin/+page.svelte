<script lang="ts">
  import { Badge } from '$lib/components/Badges';
  import FormatDate from '$lib/components/FormatDate.svelte';
  import FormatProjectType from '$lib/components/FormatProjectType.svelte';
  import Input from '$lib/forms/Input.svelte';
  import t from '$lib/i18n';
  import type { PageData } from './$types';
  import IconButton from '$lib/components/IconButton.svelte';
  import DeleteUserModal from '$lib/components/DeleteUserModal.svelte';
  import EditUserAccount from './EditUserAccount.svelte';
  import type { LoadAdminDashboardQuery } from '$lib/gql/types';
  import { notifySuccess, notifyWarning } from '$lib/notify';
  import { DialogResponse } from '$lib/components/modals';
  import { Duration } from '$lib/util/time';

  type UserRow = LoadAdminDashboardQuery['users'][0];

  export let data: PageData;
  $: allProjects = data.projects;
  $: allUsers = data.users;

  let deleteUserModal: DeleteUserModal;
  let formModal: EditUserAccount;

  async function deleteUser(user: UserRow): Promise<void> {
    formModal.close();
    const { response } = await deleteUserModal.open(user);
    if (response == DialogResponse.Submit) {
      notifyWarning($t('admin_dashboard.notifications.user_deleted', { name: user.name }));
    }
  }

  async function openModal(user: UserRow): Promise<void> {
    const { response, formState } = await formModal.openModal(user);
    if (response == DialogResponse.Submit) {
      if (formState.name.tainted || formState.password.tainted || formState.role.tainted) {
        notifySuccess($t('admin_dashboard.notifications.user_updated', { name: formState.name.currentValue }));
      }
      if (formState.email.changed) {
        notifySuccess(
          $t('admin_dashboard.notifications.email_need_verification', {
            name: user.name,
            requestedEmail: formState.email.currentValue,
          }),
          Duration.Long
        );
      }
    }
  }

  let projectSearch = '';
  let userSearch = '';
  $: projectSearchLower = projectSearch.toLocaleLowerCase();
  $: projectLimit = projectSearch ? Infinity : 10;
  $: projects = $allProjects
    .filter(
      (p) =>
        !projectSearch ||
        p.name.toLocaleLowerCase().includes(projectSearchLower) ||
        p.code.toLocaleLowerCase().includes(projectSearchLower)
    )
    .slice(0, projectLimit);
  $: userSearchLower = userSearch.toLocaleLowerCase();
  $: userLimit = userSearch ? Infinity : 10;
  $: users = $allUsers
    .filter(
      (u) =>
        !userSearch ||
        u.name.toLocaleLowerCase().includes(userSearchLower) ||
        u.email.toLocaleLowerCase().includes(userSearchLower)
    )
    .slice(0, userLimit);
</script>

<svelte:head>
  <title>{$t('admin_dashboard.title')}</title>
</svelte:head>
<main class="flex justify-center">
  <div class="grid lg:grid-cols-2 grid-cols-1 gap-10">
    <div>
      <span class="text-xl flex gap-4">
        {$t('admin_dashboard.project_table_title')}
        <Badge>
          <span class="inline-flex gap-2">
            {projects.length}
            <span>/</span>
            {$allProjects.length}
          </span>
        </Badge>
      </span>

      <Input
        type="text"
        label=""
        placeholder={$t('admin_dashboard.filter_placeholder')}
        autofocus
        bind:value={projectSearch}
      />

      <div class="divider" />
      <div class="overflow-x-auto">
        <table class="table table-lg">
          <thead>
            <tr class="bg-base-200">
              <th>{$t('admin_dashboard.column_name')}</th>
              <th>{$t('admin_dashboard.column_code')}</th>
              <th>{$t('admin_dashboard.column_users')}</th>
              <th>
                {$t('admin_dashboard.column_last_change')}
                <span class="i-mdi-sort-ascending text-xl align-[-5px] ml-2" />
              </th>
              <th>{$t('admin_dashboard.column_type')}</th>
            </tr>
          </thead>
          <tbody>
            {#each projects as project}
              <tr>
                <td>
                  <a class="link" href={`/project/${project.code}`}>
                    {project.name}
                  </a>
                </td>
                <td>{project.code}</td>
                <td>TODO</td>
                <td>
                  <FormatDate date={project.lastCommit} />
                </td>
                <td>
                  <FormatProjectType type={project.type} />
                </td>
              </tr>
            {/each}
          </tbody>
        </table>
      </div>
    </div>

    <div>
      <span class="text-xl flex gap-4">
        {$t('admin_dashboard.user_table_title')}
        <Badge>
          <span class="inline-flex gap-2">
            {users.length}
            <span>/</span>
            {$allUsers.length}
          </span>
        </Badge>
      </span>
      <Input label="" placeholder={$t('admin_dashboard.filter_placeholder')} bind:value={userSearch} />

      <div class="divider" />
      <div class="overflow-x-auto">
        <table class="table table-lg">
          <thead>
            <tr class="bg-base-200">
              <th>
                {$t('admin_dashboard.column_name')}<span class="i-mdi-sort-ascending text-xl align-[-5px] ml-2" />
              </th>
              <th>{$t('admin_dashboard.column_email')}</th>
              <th>{$t('admin_dashboard.column_role')}</th>
              <th>{$t('admin_dashboard.column_created')}</th>
              <th />
            </tr>
          </thead>
          <tbody>
            {#each users as user}
              <tr>
                <td>{user.name}</td>
                <td>{user.email}</td>
                <td class:text-accent={user.isAdmin}>
                  {user.isAdmin ? $t('user_types.admin') : $t('user_types.user')}
                </td>
                <td>
                  <FormatDate date={user.createdDate} />
                </td>
                <td class="p-0">
                  <IconButton icon="i-mdi-pencil-outline" style="btn-ghost" on:click={() => openModal(user)} />
                </td>
              </tr>
            {/each}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <EditUserAccount bind:this={formModal} {deleteUser} currUser={data.user} />
  <DeleteUserModal bind:this={deleteUserModal} i18nScope="admin_dashboard.form_modal.delete_user" />
</main>
