<script lang="ts">
  import { navigating } from '$app/stores';
  import { Badge } from '$lib/components/Badges';
  import t from '$lib/i18n';
  import type { PageData } from './$types';
  import DeleteUserModal from '$lib/components/DeleteUserModal.svelte';
  import EditUserAccount from './EditUserAccount.svelte';
  import { useNotifications } from '$lib/notify';
  import { DialogResponse } from '$lib/components/modals';
  import { Duration } from '$lib/util/time';
  import { Icon } from '$lib/icons';
  import Dropdown from '$lib/components/Dropdown.svelte';
  import FilterBar from '$lib/components/FilterBar/FilterBar.svelte';
  import { RefineFilterMessage } from '$lib/components/Table';
  import type { AdminSearchParams, User } from './+page';
  import { getSearchParams, queryParam } from '$lib/util/query-params';
  import type { ProjectType, ProjectMigrationStatus } from '$lib/gql/types';
  import { derived } from 'svelte/store';
  import AdminProjects from './AdminProjects.svelte';
  import UserModal from '$lib/components/Users/UserModal.svelte';
  import { Button } from '$lib/forms';
  import { PageBreadcrumb } from '$lib/layout';

  export let data: PageData;
  $: projects = data.projects;
  $: userData = data.users;

  const { notifySuccess, notifyWarning } = useNotifications();

  const queryParams = getSearchParams<AdminSearchParams>({
    userSearch: queryParam.string<string>(''),
    showDeletedProjects: queryParam.boolean<boolean>(false),
    projectType: queryParam.string<ProjectType | undefined>(undefined),
    userEmail: queryParam.string(undefined),
    projectSearch: queryParam.string<string>(''),
    migrationStatus: queryParam.string<ProjectMigrationStatus | 'UNMIGRATED' | undefined>(undefined),
  });

  const userFilterKeys = ['userSearch'] as const satisfies Readonly<(keyof AdminSearchParams)[]>;
  const { queryParamValues, defaultQueryParamValues } = queryParams;

  const loadingUsers = derived(navigating, (nav) => {
    const fromUrl = nav?.from?.url;
    return fromUrl && userFilterKeys.some((key) =>
      (fromUrl.searchParams.get(key) ?? defaultQueryParamValues[key])?.toString() !== $queryParamValues[key]);
  });

  let hasActiveFilter = false;
  let lastLoadUsedActiveFilter = false;
  $: if (!$loadingUsers) lastLoadUsedActiveFilter = hasActiveFilter;

  $: users = $userData?.items ?? [];
  $: filteredUserCount = $userData?.totalCount ?? 0;
  $: shownUsers = lastLoadUsedActiveFilter ? users : users.slice(0, 10);

  function filterProjectsByUser(user: User): void {
    $queryParamValues.userEmail = user.email;
  }

  let userModal: UserModal;
  let deleteUserModal: DeleteUserModal;
  let formModal: EditUserAccount;

  async function deleteUser(user: User): Promise<void> {
    formModal.close();
    const { response } = await deleteUserModal.open(user);
    if (response == DialogResponse.Submit) {
      notifyWarning($t('admin_dashboard.notifications.user_deleted', { name: user.name }));
    }
  }

  async function openModal(user: User): Promise<void> {
    const { response, formState } = await formModal.openModal(user);
    if (response == DialogResponse.Submit) {
      if (formState.name.tainted || formState.password.tainted || formState.role.tainted) {
        notifySuccess($t('admin_dashboard.notifications.user_updated', { name: formState.name.currentValue }));
      }
      if (formState.email.changed) {
        notifySuccess(
          $t('admin_dashboard.notifications.email_need_verification', {
            name: user.name,
            requestedEmail: formState.email.currentValue,
          }),
          Duration.Long,
        );
      }
    }
  }
</script>

<svelte:head>
  <title>{$t('admin_dashboard.title')}</title>
</svelte:head>
<PageBreadcrumb>{$t('admin_dashboard.title')}</PageBreadcrumb>
<main>
  <div class="grid lg:grid-cols-2 grid-cols-1 gap-10">
    <AdminProjects projects={$projects} {queryParams} />

    <div>
      <h2 class="text-2xl flex gap-4 items-end">
        {$t('admin_dashboard.user_table_title')}
        <Badge>
          <span class="inline-flex gap-2">
            {shownUsers.length}
            <span>/</span>
            {filteredUserCount}
          </span>
        </Badge>
      </h2>
      <div class="mt-4">
        <FilterBar
          debounce
          loading={$loadingUsers}
          searchKey="userSearch"
          filterKeys={userFilterKeys}
          filters={queryParamValues}
          filterDefaults={defaultQueryParamValues}
          bind:hasActiveFilter
        />
      </div>

      <div class="divider" />
      <div class="overflow-x-auto">
        <table class="table table-lg">
          <thead>
            <tr class="bg-base-200">
              <th>
                {$t('admin_dashboard.column_name')}<span class="i-mdi-sort-ascending text-xl align-[-5px] ml-2" />
              </th>
              <th>{$t('admin_dashboard.column_login')}</th>
              <th>{$t('admin_dashboard.column_email')}</th>
              <th>{$t('admin_dashboard.column_role')}</th>
              <th />
            </tr>
          </thead>
          <tbody>
            {#each shownUsers as user}
              <tr>
                <td>
                  <Button style="btn-ghost" size="btn-sm" on:click={() => userModal.open(user)}>
                    {user.name}
                    <Icon icon="i-mdi-card-account-details-outline" />
                  </Button>
                </td>
                <td>
                  {#if user.username}
                    {user.username}
                  {/if}
                </td>
                <td>
                  <span class="inline-flex items-center gap-2 text-left">
                    {user.email}
                    {#if !user.emailVerified}
                      <span
                        class="tooltip text-warning text-xl shrink-0 leading-0"
                        data-tip={$t('admin_dashboard.email_not_verified')}>
                        <span class="i-mdi-help-circle-outline" />
                      </span>
                    {/if}
                  </span>
                </td>
                <td class:text-accent={user.isAdmin}>
                  {user.isAdmin ? $t('user_types.admin') : $t('user_types.user')}
                </td>
                <td class="p-0">
                  <Dropdown>
                    <button class="btn btn-ghost btn-square">
                      <span class="i-mdi-dots-vertical text-lg" />
                    </button>
                    <ul slot="content" class="menu">
                      <li>
                        <button class="whitespace-nowrap" on:click={() => openModal(user)}>
                          <Icon icon="i-mdi-pencil-outline" />
                          {$t('admin_dashboard.form_modal.title')}
                        </button>
                      </li>
                      <li>
                        <button class="whitespace-nowrap" on:click={() => filterProjectsByUser(user)}>
                          <Icon icon="i-mdi-filter-outline" />
                          {$t('project.filter.filter_user_projects')}
                        </button>
                      </li>
                    </ul>
                  </Dropdown>
                </td>
              </tr>
            {/each}
          </tbody>
        </table>
        <RefineFilterMessage total={filteredUserCount} showing={shownUsers.length} />
      </div>
    </div>
  </div>

  <EditUserAccount bind:this={formModal} {deleteUser} currUser={data.user} />
  <DeleteUserModal bind:this={deleteUserModal} i18nScope="admin_dashboard.form_modal.delete_user" />
  <UserModal bind:this={userModal}/>
</main>
