<script lang="ts">
  import {SetupSignalR} from './lib/services/service-provider-signalr';
  import ProjectView from './ProjectView.svelte';
  import {navigate} from 'svelte-routing';
  import {AppNotification} from './lib/notifications/notifications';
  import {CloseReason} from './lib/generated-signalr-client/TypedSignalR.Client/Lexbox.ClientServer.Hubs';
  import {Entry} from './lib/mini-lcm';

  export let projectName: string;
  const {connected, lexboxApi} = SetupSignalR(`/api/hub/${projectName}/fwdata`, {
      history: false,
      write: true,
      openWithFlex: true,
      feedback: true
    },
    {
      OnEntryUpdated: async (entry: Entry) => {
      },
      async OnProjectClosed(reason: CloseReason): Promise<void> {
        $connected = false;
        switch (reason) {
          case CloseReason.User:
            navigate('/');
            AppNotification.display('Project closed on another tab', 'warning', 'long');
            break;
          case CloseReason.Locked:
            AppNotification.displayAction('The project is open in FieldWorks. Please close it and try again.', 'warning', {
              label: 'Retry',
              callback: () => $connected = true
            });
            break;
        }
      }
    },
    (errorContext) => {
      if (errorContext.error instanceof Error) {
        let message = errorContext.error.message;
        if (message.includes('The project is locked')) return {handled: true}; //handled via the project closed callback
      }
      return {handled: false};
    }
  );
</script>
<ProjectView {projectName} isConnected={$connected}></ProjectView>
