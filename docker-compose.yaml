name: lexbox

services:
  lexbox-api:
    tty: true # for dev tools
    stdin_open: true # for dev tools
    build:
      context: backend
      dockerfile: LexBoxApi/dev.Dockerfile
    ports:
      - "5158:5158" # 5158 exposed here for dev tools, and the runtime should only expose 80
    # https://docs.docker.com/compose/compose-file/#depends_on
    depends_on:
      db:
        condition: service_healthy
      hasura:
        condition: service_healthy
      hgweb:
        condition: service_started
      hgresume:
        condition: service_started
      otel-collector:
        condition: service_started
    volumes:
      - hg-repos:/hg-repos

      # for dev convenience
      - ./backend:/src/backend
      - nuget-cache:/root/.nuget/packages
    env_file: .env
    environment:
      DbConfig__LexBoxConnectionString: Host=db;Port=5432;Username=postgres;Password=${POSTGRES_PASSWORD};Database=${POSTGRES_DB}
      HasuraConfig__HasuraUrl: http://hasura:8080/v1/graphql
      HasuraConfig__HasuraSecret: ${HASURA_GRAPHQL_ADMIN_SECRET}
      HgConfig__RepoPath: /hg-repos
      HgConfig__HgWebUrl: http://hgweb:80
      Clusters__hg-web__Destinations__hg-web-server__Address: http://hgweb:80
      Clusters__resumable-web__Destinations__resumable-web-server__Address: http://hg-resumable:80

      # for dev convenience
      ASPNETCORE_ENVIRONMENT: Development

  hasura:
    build: ./hasura
    ports:
      - "8081:8080" # 8081 exposed here for dev tools
    depends_on:
      db:
        condition: service_healthy
    env_file: .env
    environment:
      HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
      PG_DATABASE_URL: postgres://postgres:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}

      # for dev convenience
      HASURA_GRAPHQL_WEBSOCKET_KEEPALIVE: 20
      HASURA_GRAPHQL_DEV_MODE: "true"

  db:
    image: postgres:15-alpine
    restart: unless-stopped
    ports:
      - "5433:5432" # 5433 exposed here for dev tools
    volumes:
      - db-data:/var/lib/postgresql
    healthcheck: # TODO: do we need this in k8s?
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    env_file: .env

  redmine-db:
    image: mysql:5.7.41
    platform:  linux/amd64
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: the_password
    volumes:
      - redmine_db_data:/var/lib/mysql

  hgweb:
    image: anteru/hgweb-docker:5.6 # TODO: need to find appropriate image, this one is only temporary
    platform: linux/amd64
    ports:
      - "8080:80" # 8080 exposed here for dev tools
    command: ["apache2ctl", "-DFOREGROUND"]
    volumes:
      - hg-repos:/var/hg/repos

  hgresume:
    image: ghcr.io/sillsdev/hgresume:v2023-02-24
    platform:  linux/amd64
    ports:
      - "8034:80" # 8034 exposed here for dev tools
    volumes:
      - hg-repos:/var/vcs/public
      - hgresume-cache:/var/cache/hgresume

  otel-collector:
    build: ./otel
    volumes:
      # for dev convenience
      - ./otel/config.yaml:/etc/config.yaml
    ports:
      # TODO: determine why these are exsposed to the host.
      - 4317:4317 # OTLP gRPC receiver - only required when running backend locally
      - 4318:4318 # OTLP http receiver
      #- 13133:13133 # health_check extension - only required when running backend locally
    env_file: .env

volumes:
    db-data:
    hg-repos:
      # wanted this shared volume to get loaded from local filesystem during dev only
      driver: local
      driver_opts:
        device: ./hgweb/repos
        o: bind
        type: none
    redmine_db_data:
    hgresume-cache:
    nuget-cache:
